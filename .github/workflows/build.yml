name: Build TabSaver

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install JUCE dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libasound2-dev \
          libjack-jackd2-dev \
          ladspa-sdk \
          libcurl4-openssl-dev \
          libfreetype6-dev \
          libx11-dev \
          libxcomposite-dev \
          libxcursor-dev \
          libxext-dev \
          libxinerama-dev \
          libxrandr-dev \
          libxrender-dev \
          libwebkit2gtk-4.1-dev \
          libglu1-mesa-dev \
          mesa-common-dev

    - name: Setup CMake
      uses: lukka/get-cmake@latest

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: List build output
      shell: bash
      run: |
        echo "Build directory contents:"
        ls -R build/ || true
        echo "Looking for artefacts:"
        find build -name "*.vst3" -o -name "*.component" -o -name "*.app" -o -name "*.exe" || true

    - name: Prepare artifacts (macOS)
      if: runner.os == 'macOS'
      run: |
        mkdir -p artifacts
        if [ -d "build/TabVST_artefacts/Release/VST3/TabSaver.vst3" ]; then
          cp -r build/TabVST_artefacts/Release/VST3/TabSaver.vst3 artifacts/
        fi
        if [ -d "build/TabVST_artefacts/Release/Standalone/TabSaver.app" ]; then
          cp -r build/TabVST_artefacts/Release/Standalone/TabSaver.app artifacts/
        fi
        if [ -d "build/TabVST_artefacts/Release/AU/TabSaver.component" ]; then
          cp -r build/TabVST_artefacts/Release/AU/TabSaver.component artifacts/
        fi

    - name: Prepare artifacts (Windows)
      if: runner.os == 'Windows'
      shell: bash
      run: |
        mkdir -p artifacts
        if [ -d "build/TabVST_artefacts/Release/VST3/TabSaver.vst3" ]; then
          cp -r build/TabVST_artefacts/Release/VST3/TabSaver.vst3 artifacts/
        fi
        if [ -f "build/TabVST_artefacts/Release/Standalone/TabSaver.exe" ]; then
          cp build/TabVST_artefacts/Release/Standalone/TabSaver.exe artifacts/
        fi

    - name: Prepare artifacts (Linux)
      if: runner.os == 'Linux'
      run: |
        mkdir -p artifacts
        if [ -d "build/TabVST_artefacts/Release/VST3/TabSaver.vst3" ]; then
          cp -r build/TabVST_artefacts/Release/VST3/TabSaver.vst3 artifacts/
        fi
        if [ -f "build/TabVST_artefacts/Release/Standalone/TabSaver" ]; then
          cp build/TabVST_artefacts/Release/Standalone/TabSaver artifacts/
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: TabSaver-${{ runner.os }}
        path: artifacts/
        if-no-files-found: warn

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts

    - name: Display structure
      run: ls -R release-artifacts

    - name: Create archives
      run: |
        cd release-artifacts
        for dir in */; do
          if [ -d "$dir" ] && [ "$(ls -A $dir)" ]; then
            dirname=${dir%/}
            tar -czf "${dirname}.tar.gz" -C "$dir" .
          fi
        done

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release-artifacts/*.tar.gz
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
