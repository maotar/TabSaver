name: Build TabSaver

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install JUCE dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libasound2-dev \
          libjack-jackd2-dev \
          ladspa-sdk \
          libcurl4-openssl-dev \
          libfreetype6-dev \
          libx11-dev \
          libxcomposite-dev \
          libxcursor-dev \
          libxcursor-dev \
          libxext-dev \
          libxinerama-dev \
          libxrandr-dev \
          libxrender-dev \
          libwebkit2gtk-4.0-dev \
          libglu1-mesa-dev \
          mesa-common-dev

    - name: Setup CMake
      uses: lukka/get-cmake@latest

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Prepare artifacts (macOS)
      if: runner.os == 'macOS'
      run: |
        mkdir -p artifacts
        if [ -d "build/TabSaver_artefacts/Release/VST3/TabSaver.vst3" ]; then
          cp -r build/TabSaver_artefacts/Release/VST3/TabSaver.vst3 artifacts/
        fi
        if [ -d "build/TabSaver_artefacts/Release/Standalone/TabSaver.app" ]; then
          cp -r build/TabSaver_artefacts/Release/Standalone/TabSaver.app artifacts/
        fi
        if [ -d "build/TabSaver_artefacts/Release/AU/TabSaver.component" ]; then
          cp -r build/TabSaver_artefacts/Release/AU/TabSaver.component artifacts/
        fi

    - name: Prepare artifacts (Windows)
      if: runner.os == 'Windows'
      shell: bash
      run: |
        mkdir -p artifacts
        if [ -d "build/TabSaver_artefacts/Release/VST3/TabSaver.vst3" ]; then
          cp -r build/TabSaver_artefacts/Release/VST3/TabSaver.vst3 artifacts/
        fi
        if [ -f "build/TabSaver_artefacts/Release/Standalone/TabSaver.exe" ]; then
          cp build/TabSaver_artefacts/Release/Standalone/TabSaver.exe artifacts/
        fi

    - name: Prepare artifacts (Linux)
      if: runner.os == 'Linux'
      run: |
        mkdir -p artifacts
        if [ -d "build/TabSaver_artefacts/Release/VST3/TabSaver.vst3" ]; then
          cp -r build/TabSaver_artefacts/Release/VST3/TabSaver.vst3 artifacts/
        fi
        if [ -f "build/TabSaver_artefacts/Release/Standalone/TabSaver" ]; then
          cp build/TabSaver_artefacts/Release/Standalone/TabSaver artifacts/
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: TabSaver-${{ runner.os }}
        path: artifacts/
        if-no-files-found: warn

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: release-artifacts

    - name: Display structure
      run: ls -R release-artifacts

    - name: Create archives
      run: |
        cd release-artifacts
        for dir in */; do
          if [ -d "$dir" ] && [ "$(ls -A $dir)" ]; then
            dirname=${dir%/}
            tar -czf "${dirname}.tar.gz" -C "$dir" .
          fi
        done

    - name: Upload release artifacts
      uses: actions/upload-artifact@v3
      with:
        name: TabSaver-All-Platforms
        path: release-artifacts/*.tar.gz
        if-no-files-found: warn
