name: Build TabSaver

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install JUCE dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libasound2-dev \
          libjack-jackd2-dev \
          ladspa-sdk \
          libcurl4-openssl-dev \
          libfreetype6-dev \
          libx11-dev \
          libxcomposite-dev \
          libxcursor-dev \
          libxext-dev \
          libxinerama-dev \
          libxrandr-dev \
          libxrender-dev \
          libwebkit2gtk-4.1-dev \
          libglu1-mesa-dev \
          mesa-common-dev

    - name: Setup CMake
      uses: lukka/get-cmake@latest

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: List build output
      shell: bash
      run: |
        echo "Build directory contents:"
        ls -R build/ || true
        echo "Looking for artefacts:"
        find build -name "*.vst3" -o -name "*.component" -o -name "*.app" -o -name "*.exe" || true

    - name: Prepare artifacts (macOS)
      if: runner.os == 'macOS'
      run: |
        mkdir -p artifacts
        if [ -d "build/TabVST_artefacts/Release/VST3/TabSaver.vst3" ]; then
          cp -r build/TabVST_artefacts/Release/VST3/TabSaver.vst3 artifacts/
        fi
        if [ -d "build/TabVST_artefacts/Release/AU/TabSaver.component" ]; then
          cp -r build/TabVST_artefacts/Release/AU/TabSaver.component artifacts/
        fi
        # Add install script and instructions
        cp install-macos.sh artifacts/
        cp README-INSTALL.txt artifacts/

    - name: Prepare artifacts (Windows)
      if: runner.os == 'Windows'
      shell: bash
      run: |
        mkdir -p artifacts
        if [ -d "build/TabVST_artefacts/Release/VST3/TabSaver.vst3" ]; then
          cp -r build/TabVST_artefacts/Release/VST3/TabSaver.vst3 artifacts/
        fi
        cp README-INSTALL.txt artifacts/

    - name: Prepare artifacts (Linux)
      if: runner.os == 'Linux'
      run: |
        mkdir -p artifacts
        if [ -d "build/TabVST_artefacts/Release/VST3/TabSaver.vst3" ]; then
          cp -r build/TabVST_artefacts/Release/VST3/TabSaver.vst3 artifacts/
        fi
        cp README-INSTALL.txt artifacts/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: TabSaver-${{ runner.os }}
        path: artifacts/
        if-no-files-found: warn

  sign-and-notarize-macos:
    name: Sign and Notarize macOS
    needs: build
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download macOS artifacts
      uses: actions/download-artifact@v4
      with:
        name: TabSaver-macOS
        path: artifacts

    - name: Sign and Notarize
      env:
        DEVELOPER_ID_CERTIFICATE: ${{ secrets.DEVELOPER_ID_CERTIFICATE }}
        DEVELOPER_ID_CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_ID_CERTIFICATE_PASSWORD }}
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        chmod +x .github/scripts/sign-and-notarize.sh
        .github/scripts/sign-and-notarize.sh

    - name: Upload signed DMG
      uses: actions/upload-artifact@v4
      with:
        name: TabSaver-macOS-DMG
        path: TabSaver-*.dmg
        if-no-files-found: error

  create-release:
    name: Create Release
    needs: [build, sign-and-notarize-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts

    - name: Display structure
      run: ls -R release-artifacts

    - name: Create archives
      run: |
        cd release-artifacts
        # Create tar.gz for Linux and Windows
        for dir in TabSaver-Linux TabSaver-Windows; do
          if [ -d "$dir" ] && [ "$(ls -A $dir)" ]; then
            tar -czf "${dir}.tar.gz" -C "$dir" .
          fi
        done
        # Move DMG to root level (no need to archive)
        if [ -d "TabSaver-macOS-DMG" ]; then
          mv TabSaver-macOS-DMG/*.dmg . || true
        fi

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release-artifacts/*.tar.gz
          release-artifacts/*.dmg
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
